name: Agregar Píldora al data.yml

on:
  issues:
    types: [labeled]

jobs:
  add_pildora:
    if: github.event.label.name == 'píldora aceptada'
    runs-on: ubuntu-latest

    steps:
      - name: Clonar el repositorio
        uses: actions/checkout@v3

      - name: Configurar Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Procesar la Issue
        id: process
        env:
          BODY: ${{ github.event.issue.body }}
        run: |
          set -e
          # Extraer datos del cuerpo de la issue
          FECHA=$(echo "$BODY" | awk '/Fecha de la/{getline; while($0==""){getline}; print}')

          URL=$(echo "$BODY" | awk '/Enlace relevante/{getline; while($0==""){getline}; print}')
          [ "$URL" = "_No response_" ] && URL=""

          DESCRIPCION=$(echo "$BODY" | awk '/Descripción/{flag=1; next} flag{print}' | grep -v '^$' | grep -vF '![' | grep -v '<img')

          if [ -z "$URL" ]; then
            URL=$(echo "$DESCRIPCION" | grep -oP 'https?://\\S+' | head -n1)
          fi
          [ -z "$URL" ] && URL="null"

          IMAGE_URL=$(echo "$BODY" | sed -nE 's/.*!?\\[[^]]*\\]\\((https?:[^) ]+)\\).*/\1/p' | head -n1)
          if [ -z "$IMAGE_URL" ]; then
            IMAGE_URL=$(echo "$BODY" | sed -nE 's/.*<img[^>]+src="([^" >]+)".*/\1/p' | head -n1)
          fi

          if [ -n "$IMAGE_URL" ]; then
            MIME=$(curl -sIL "$IMAGE_URL" | grep -i '^content-type:' | tail -1 | tr -d '\r' | awk '{print $2}' | cut -d';' -f1)
            # Validar que sea una imagen
            if echo "$MIME" | grep -qE '^image/'; then
              EXT=${MIME##*/}
              [ "$EXT" = "jpeg" ] && EXT=jpg
            else
              # Fallback: extraer extensión de la URL
              EXT=$(echo "$IMAGE_URL" | sed -nE 's/.*\.([a-zA-Z0-9]+)(\?.*)?$/\1/p' | tr '[:upper:]' '[:lower:]')
              [ "$EXT" = "jpeg" ] && EXT=jpg
              # Si no hay extensión válida, usar jpg por defecto
              if ! echo "$EXT" | grep -qE '^(jpg|jpeg|png|gif|webp|svg)$'; then
                EXT=jpg
              fi
            fi
            curl -L "$IMAGE_URL" -o "images/$FECHA.$EXT"
            IMAGEN="$FECHA.$EXT"
          else
            IMAGEN="null"
          fi

          echo "  - date: '$FECHA'" > entry.yml
          echo "    image: $IMAGEN" >> entry.yml
          echo "    url: $URL" >> entry.yml
          echo "    description: |" >> entry.yml
          echo "$DESCRIPCION" | sed 's/^/      /' >> entry.yml

          echo "FECHA=$FECHA" >> $GITHUB_OUTPUT
          echo "IMAGEN=$IMAGEN" >> $GITHUB_OUTPUT

      - name: Actualizar el archivo data.yml
        run: |
          printf '\n' >> data.yml
          cat entry.yml >> data.yml

      - name: Hacer commit y push
        env:
          FECHA: ${{ steps.process.outputs.FECHA }}
          IMAGEN: ${{ steps.process.outputs.IMAGEN }}
        run: |
          git add data.yml
          if [ "$IMAGEN" != "null" ]; then
            git add "images/$IMAGEN"
          fi
          git commit -m "Agregar píldora del $FECHA"
          git push
